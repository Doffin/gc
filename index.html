<!DOCTYPE html>
<html lang="en-US" dir="ltr">

<head>
    <meta charset="UTF-8" />
    <meta name="description" content="Dette er en test pÃ¥ PWA versjon.">
    <link rel="manifest" href="manifest.json">
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="shortcut icon" href="icon.png" />
    <link rel="stylesheet" href="w3.css">

    <title>GroundCheck</title>
    <script src="w3.js"></script>
    <script src="chart.umd.min.js"></script>
    <!-- Paho MQTT client for MQTT support -->
    <script src="paho-mqtt-min.js"></script>

    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <script defer src="js/languageLoader.js"></script>
    <script src="js/gcSetupPanel.js" type="module"></script>
    <script src="js/gcLivePanel.js" type="module"></script>
</head>

<body class="w3-container">
    <p id="versionNr">Version 1.0.64</p>
    <select id="language-select">
        <!-- Language options loaded from lang/config.json -->
    </select>
    <button id="install_button" hidden>Install</button>
    <button onclick="toggleColorMode()">Toggle Dark Mode</button>
    <input type="button" id="clear-cache" value="Refresh" onclick="clearCache()" />
    <gc-setup-panel id="setup"></gc-setup-panel>
    <gc-live-panel id="live"></gc-live-panel>
     
    <div class="w3-panel w3-light-grey">
        <p id="messages">Messages will appear here.</p>
    </div>
    <script>
        if ('serviceWorker' in navigator) {
            // navigator.serviceWorker.register('./sw.js', { scope: './' });            
        }
    </script>
    <script src="app.js"></script>
    <script>
        let mode = 'dark';
        const live = document.getElementById("live");
        const setup = document.getElementById("setup");
        w3.includeHTML();
        
        window.onload = function () {
            applyColorMode(mode);
            
            // Listen for messages from setup panel
            setup.addEventListener('gc-message', (e) => {
                onMessage(e.detail.message);
            });
            
            // Listen for status messages from setup panel
            setup.addEventListener('gc-status', (e) => {
                showMessage(e.detail.text);
            });
        };

        const key = 'vk_test_v1';
        function clearCache() {
            caches.delete(key);
            location.reload();
        }

        function toggleColorMode() {
            if(mode === 'dark') {
                mode = 'light';
            } else {
                mode = 'dark';
            }   
            applyColorMode(mode);
        }

        function applyColorMode(newMode) 
        {
            mode = newMode;
            document.body.style.backgroundColor = mode === 'dark' ? '#121212' : '#ffffff';
            document.body.style.color = mode === 'dark' ? '#e0e0e0' : '#000000';
            live.setColorMode(mode);
            setup.setColorMode(mode);
        }    

        function showMessage(message) {
            const messages = document.getElementById('messages');
            if (!messages) return;
            messages.innerHTML = `${message}`;
        }

        function onMessage(msg) {
            try {
                if(msg.type && msg.type.startsWith("gc_")) {
                    live.update(msg);
                    showMessage(`Received: ${msg.type} - phase: ${msg.phase}, last: ${msg.last}, setning: ${msg.setning}`);
                }
            } catch (error) {
                showMessage(`Error parsing message: ${error.message}`);
            }
        }

        function sendRequest(msg) {
            setup.sendMessage(msg);
        }

    </script>

</body>


</html>