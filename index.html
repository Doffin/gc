<!DOCTYPE html>
<html lang="en-US" dir="ltr">

<head>
    <meta charset="UTF-8" />
    <meta name="description" content="Dette er en test på PWA versjon.">
    <link rel="manifest" href="manifest.json">
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="shortcut icon" href="icon.png" />
    <link rel="stylesheet" href="w3.css">

    <title>GroundCheck</title>
    <script src="w3.js"></script>
    <script src="chart.umd.min.js"></script>

    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <script defer src="js/languageLoader.js"></script>
    <script src="js/gcLivePanel.js" type="module"></script>
</head>

<body class="w3-container">
    <p id="versionNr">Version 1.0.29</p>
    <select id="language-select">
        <option value="norsk">Norsk</option>
        <option value="english">English</option>
        <option value="polish">Polski</option>
    </select>
    <button id="install_button" hidden>Install</button>
    <label>Name: <input id="nameInput" value="" /></label>
    <button id="updateVars">Oppdater variabler</button>
    <button onclick="live.toggleMode()">Toggle Dark Mode</button>
    <input type="button" id="clear-cache" value="Refresh" onclick="clearCache()" />
    <br />

    <h1 data-i18n="content.title">TITTEL</h1>
    <p data-i18n="content.body">BODY</p>
    <hr />
    <gc-live-panel id="live"></gc-live-panel>
    <hr />
     
    <div class="w3-row">
        <div class="w3-col l4 w3-left">
            <p class="w3-panel" w3-include-html="customers.html"></p>
        </div>
        <div class="w3-col l8 w3-center">
            <div class="w3-panel w3-card-4">
                <canvas id="myChart" style="width:80%;max-width:700px"></canvas>
            </div>
        </div>
    </div>
    <div class="w3-panel w3-light-grey">
        <p id="messages">Messages will appear here.</p>
    </div>
    <script>
        if ('serviceWorker' in navigator) {
            // navigator.serviceWorker.register('./sw.js', { scope: './' });            
        }
    </script>
    <script src="app.js"></script>
    <script>
        w3.includeHTML();
        let ws = null;
        window.onload = function () {
            initWebSocket();
        };

        const key = 'vk_test_v1';
        function clearCache() {
            caches.delete(key);
            location.reload();
        }


        function showMessage(message) {
            const messages = document.getElementById('messages');
            if (!messages) return;
            messages.innerHTML = `${message}`;
        }

        function initWebSocket() {
            if (ws) {
                showMessage('WebSocket is already initialized.');
                return;
            }
            ws = new WebSocket(`ws://localhost:8080`);
            ws.onerror = function () {
                showMessage('WebSocket error');
            };
            ws.onopen = function () {
                showMessage('WebSocket connection established');
            };
            ws.onclose = function () {
                showMessage('WebSocket connection closed');
                ws = null;
            };
            ws.sendMessage = function (message) {
                if (ws) {
                    ws.send(message);
                    setTimeout(function () {
                        showMessage("...");
                    }, 2000);
                } else {
                    showMessage('WebSocket is not connected.');
                }
            };
            ws.onmessage = function (event) {
                try {
                    const msg = JSON.parse(event.data);
                    if (msg.tid) {
                        const tidElem = document.getElementById('live_tid');
                        if (tidElem) tidElem.innerHTML = msg.tid;
                    }
                    if (msg.last) {
                        const lastElem = document.getElementById('live_last');
                        if (lastElem) lastElem.innerHTML = msg.last;
                    }
                    if (msg.setning) {
                        const setningElem = document.getElementById('live_setning');
                        if (setningElem) setningElem.innerHTML = msg.setning;
                    }
                    if (msg.type && msg.type === 'ptm_save') {
                        updateTable();
                    }
                    return;
                } catch (error) {
                    showMessage(event.data);
                    return;
                }
            };
        }
        function sendRequest(msg) {
            if (ws) {
                ws.sendMessage(msg);
            } else {
                showMessage('WebSocket is not connected.');
            }
        }

        function updateTable() {
            let lastSuffix = '10';
            // Shift existing rows up
            for (let i = 1; i < 10; i++) {
                let toSuffix = i < 10 ? `0${i}` : `${i}`;
                let fromSuffix = i < 9 ? `0${i + 1}` : `${i + 1}`;
                lastSuffix = fromSuffix;
                document.getElementById(`tid_` + toSuffix).innerHTML = document.getElementById(`tid_` + fromSuffix).innerHTML;
                document.getElementById(`last_` + toSuffix).innerHTML = document.getElementById(`last_` + fromSuffix).innerHTML;
                document.getElementById(`setning_` + toSuffix).innerHTML = document.getElementById(`setning_` + fromSuffix).innerHTML;
            }
            document.getElementById('tid_' + lastSuffix).innerHTML = document.getElementById(`live_tid`).innerHTML;
            document.getElementById('last_' + lastSuffix).innerHTML = document.getElementById(`live_last`).innerHTML;
            document.getElementById('setning_' + lastSuffix).innerHTML = document.getElementById(`live_setning`).innerHTML;
        }

        const xValues = [0, 100, 200, 300, 400, 500, 600];

        const ctx = document.getElementById('myChart');
        let chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: xValues,
                datasets: [{
                    label: 'Displacement as function of load',
                    borderColor: 'blue',
                    data: [0, 10, 25, 40, 60, 85, 120],
                    fill: false,
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Displacement as function of load'
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Load [kN/m2]'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Displacement [mm]'
                        }
                    }
                }
            }
        });
    </script>
    <script>

        const live = document.getElementById("live");
        // Simuler innkommende sensor-data
            setInterval(() => {
                live.update({
                    temperature: (20 + Math.random() * 5).toFixed(1) + " °C",
                    humidity: (40 + Math.random() * 10).toFixed(1) + " %",
                    pressure: (1000 + Math.random() * 20).toFixed(1) + " hPa"
                });
            }, 1000);
    </script>

</body>


</html>