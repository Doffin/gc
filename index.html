<!DOCTYPE html>
<html lang="en-US" dir="ltr">

<head>
    <meta charset="UTF-8" />
    <meta name="description" content="Dette er en test pÃ¥ PWA versjon.">
    <link rel="manifest" href="manifest.json">
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="shortcut icon" href="icon.png" />
    <link rel="stylesheet" href="w3.css">

    <title>GroundCheck</title>
    <script src="w3.js"></script>
    <script src="chart.umd.min.js"></script>

    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <script defer src="js/languageLoader.js"></script>
    <script src="js/gcLivePanel.js" type="module"></script>
</head>

<body class="w3-container">
    <p id="versionNr">Version 1.0.51</p>
    <select id="language-select">
        <option value="norsk">Norsk</option>
        <option value="english">English</option>
        <option value="polish">Polski</option>
    </select>
    <button id="install_button" hidden>Install</button>
    <label>Name: <input id="nameInput" value="" /></label>
    <button id="updateVars">Oppdater variabler</button>
    <button onclick="toggleColorMode()">Toggle Dark Mode</button>
    <input type="button" id="clear-cache" value="Refresh" onclick="clearCache()" />
    <br />

    <h1 data-i18n="content.title">TITTEL</h1>
    <p data-i18n="content.body">BODY</p>
    <hr />
    <gc-live-panel id="live"></gc-live-panel>
    <hr />
     
    <div class="w3-panel w3-light-grey">
        <p id="messages">Messages will appear here.</p>
    </div>
    <script>
        if ('serviceWorker' in navigator) {
            // navigator.serviceWorker.register('./sw.js', { scope: './' });            
        }
    </script>
    <script src="app.js"></script>
    <script>
        let mode = 'dark';
        const live = document.getElementById("live");
        w3.includeHTML();
        let ws = null;
        window.onload = function () {
            initWebSocket();
            applyColorMode(mode);
        };

        const key = 'vk_test_v1';
        function clearCache() {
            caches.delete(key);
            location.reload();
        }

        function toggleColorMode() {
            if(mode === 'dark') {
                mode = 'light';
            } else {
                mode = 'dark';
            }   
            applyColorMode(mode);
        }

        function applyColorMode(newMode) 
        {
            mode = newMode;
            document.body.style.backgroundColor = mode === 'dark' ? '#121212' : '#ffffff';
            document.body.style.color = mode === 'dark' ? '#e0e0e0' : '#000000';
            document.getElementById('live').setColorMode(mode);
        }    

        function showMessage(message) {
            const messages = document.getElementById('messages');
            if (!messages) return;
            messages.innerHTML = `${message}`;
        }

        function initWebSocket() {
            if (ws) {
                showMessage('WebSocket is already initialized.');
                return;
            }
            ws = new WebSocket(`ws://localhost:8080`);
            ws.onerror = function () {
                showMessage('WebSocket error');
            };
            ws.onopen = function () {
                showMessage('WebSocket connection established');
            };
            ws.onclose = function () {
                showMessage('WebSocket connection closed');
                ws = null;
            };
            ws.sendMessage = function (message) {
                if (ws) {
                    ws.send(message);
                    setTimeout(function () {
                        showMessage("...");
                    }, 2000);
                } else {
                    showMessage('WebSocket is not connected.');
                }
            };
            ws.onmessage = function (event) {
                try {
                    const msg = JSON.parse(event.data);
                    if(msg.type && msg.type === 'ptm_live') {
                        live.update(msg);
                    }
                    return;
                } catch (error) {
                    showMessage(event.data);
                    return;
                }
            };
        }
        function sendRequest(msg) {
            if (ws) {
                ws.sendMessage(msg);
            } else {
                showMessage('WebSocket is not connected.');
            }
        }

    </script>

</body>


</html>