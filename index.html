<!DOCTYPE html>
<html lang="en-EN" dir="ltr">

<head>
    <meta charset="UTF-8" />
    <meta name="description" content="Dette er en test pÃ¥ PWA versjon.">
    <link rel="manifest" href="manifest.json">
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="shortcut icon" href="icon.png" />
    <link rel="stylesheet" href="css/w3.css">

    <title>GroundCheck</title>
    <script src="js/w3.js"></script>
    <script src="js/chart.umd.min.js"></script>
    <script src="js/paho-mqtt-min.js"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <script defer src="js/languageLoader.js"></script>
    <script src="js/gcSetupPanel.js" type="module"></script>
    <script src="js/gcLivePanel.js" type="module"></script>
    <style>
        .menu-container {
            position: relative;
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px 0 10px 0;
        }
        .hamburger-btn {
            background: none;
            border: 1px solid #ccc;
            cursor: pointer;
            padding: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
        }
        .hamburger-btn:hover {
            background-color: rgba(128, 128, 128, 0.2);
        }
        body[data-mode="dark"] .hamburger-btn {
            border-color: #555;
            background-color: rgba(255, 255, 255, 0.1);
        }
        body[data-mode="dark"] .hamburger-btn:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        .hamburger-icon {
            width: 24px;
            height: 24px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .hamburger-icon span {
            display: block;
            width: 100%;
            height: 3px;
            background-color: currentColor;
            border-radius: 2px;
        }
        .dropdown-menu {
            position: absolute;
            top: 50px;
            left: 0;
            background-color: #ffffff;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            display: none;
            flex-direction: column;
            min-width: 200px;
            z-index: 1000;
        }
        .dropdown-menu.show {
            display: flex;
        }
        body[data-mode="dark"] .dropdown-menu {
            background-color: #2a2a2a;
            border-color: #555;
        }
        .menu-item {
            padding: 12px 16px;
            cursor: pointer;
            border: none;
            background: none;
            text-align: left;
            font-size: 14px;
            color: inherit;
            transition: background-color 0.2s;
        }
        .menu-item:hover {
            background-color: rgba(128, 128, 128, 0.2);
        }
        .menu-item:first-child {
            border-top-left-radius: 4px;
            border-top-right-radius: 4px;
        }
        .menu-item:last-child {
            border-bottom-left-radius: 4px;
            border-bottom-right-radius: 4px;
        }
        .menu-separator {
            height: 1px;
            background-color: #ccc;
            margin: 4px 0;
        }
        body[data-mode="dark"] .menu-separator {
            background-color: #555;
        }
    </style>
</head>

<body class="w3-container" data-mode="dark">
    <div class="menu-container">
        <button class="hamburger-btn" onclick="toggleMenu()" aria-label="Menu">
            <div class="hamburger-icon">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </button>
        <select id="language-select">
            <!-- Language options loaded from lang/config.json -->
        </select>
        <p id="versionNr" style="margin: 0; margin-left: auto;">Version 1.0.69</p>
        <button id="install_button" hidden>Install</button>
        
        <div id="dropdown-menu" class="dropdown-menu">
            <button class="menu-item" onclick="toggleSetup(); closeMenu();">Setup</button>
            <button class="menu-item" onclick="toggleColorMode(); closeMenu();">Toggle Dark Mode</button>
            <div class="menu-separator"></div>
            <button class="menu-item" onclick="clearCache();">Refresh</button>
        </div>
    </div>
    <gc-setup-panel id="setup" style="display: none;"></gc-setup-panel>
    <gc-live-panel id="live"></gc-live-panel>
     
    <div class="w3-panel w3-light-grey">
        <p id="messages">Messages will appear here.</p>
    </div>
    <script>
        if ('serviceWorker' in navigator) {
            // navigator.serviceWorker.register('./sw.js', { scope: './' });            
        }
    </script>
    <script src="js/app.js"></script>
    <script>
        let mode = 'dark';
        const live = document.getElementById("live");
        const setup = document.getElementById("setup");
        w3.includeHTML();
        
        window.onload = function () {
            applyColorMode(mode);
            
            // Listen for messages from setup panel
            setup.addEventListener('gc-message', (e) => {
                onMessage(e.detail.message);
            });
            
            // Listen for status messages from setup panel
            setup.addEventListener('gc-status', (e) => {
                showMessage(e.detail.text);
            });
        };

        const key = 'vk_test_v1';
        function clearCache() {
            caches.delete(key);
            location.reload();
        }

        function toggleColorMode() {
            if(mode === 'dark') {
                mode = 'light';
            } else {
                mode = 'dark';
            }   
            applyColorMode(mode);
        }

        function applyColorMode(newMode) 
        {
            mode = newMode;
            document.body.setAttribute('data-mode', mode);
            document.body.style.backgroundColor = mode === 'dark' ? '#121212' : '#ffffff';
            document.body.style.color = mode === 'dark' ? '#e0e0e0' : '#000000';
            live.setColorMode(mode);
            setup.setColorMode(mode);
        }    

        function showMessage(message) {
            const messages = document.getElementById('messages');
            if (!messages) return;
            messages.innerHTML = `${message}`;
        }

        function onMessage(msg) {
            try {
//                if(msg.type && msg.type.startsWith("gc-")) {
                    live.update(msg);
                    showMessage(`Received: ${msg.type} - phase: ${msg.phase}, last: ${msg.last}, setning: ${msg.setning}`);
  //              }
            } catch (error) {
                showMessage(`Error parsing message: ${error.message}`);
            }
        }

        function sendRequest(msg) {
            setup.sendMessage(msg);
        }

        function toggleSetup() {
            const setupPanel = document.getElementById('setup');
            if (setupPanel.style.display === 'none') {
                setupPanel.style.display = 'block';
            } else {
                setupPanel.style.display = 'none';
            }
        }

        function toggleMenu() {
            const menu = document.getElementById('dropdown-menu');
            menu.classList.toggle('show');
        }

        function closeMenu() {
            const menu = document.getElementById('dropdown-menu');
            menu.classList.remove('show');
        }

        // Close menu when clicking outside
        document.addEventListener('click', (e) => {
            const menu = document.getElementById('dropdown-menu');
            const hamburger = document.querySelector('.hamburger-btn');
            if (menu && !menu.contains(e.target) && !hamburger.contains(e.target)) {
                closeMenu();
            }
        });

    </script>

</body>


</html>