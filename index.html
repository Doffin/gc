<!DOCTYPE html>
<html lang="en-US" dir="ltr">

<head>
    <meta charset="UTF-8" />
    <meta name="description" content="Dette er en test på PWA versjon.">
    <link rel="manifest" href="manifest.json">
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="shortcut icon" href="icon.png" />
    <link rel="stylesheet" href="w3.css">

    <title>GroundCheck</title>
    <script src="w3.js"></script>
    <script src="chart.umd.min.js"></script>
    <!-- Paho MQTT client for MQTT support -->
    <script src="paho-mqtt-min.js"></script>

    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <script defer src="js/languageLoader.js"></script>
    <script src="js/gcLivePanel.js" type="module"></script>
</head>

<body class="w3-container">
    <p id="versionNr">Version 1.0.59</p>
    <select id="language-select">
        <option value="norsk">Norsk</option>
        <option value="english">English</option>
        <option value="polish">Polski</option>
    </select>
    <button id="install_button" hidden>Install</button>
    <button onclick="toggleColorMode()">Toggle Dark Mode</button>
    <input type="button" id="clear-cache" value="Refresh" onclick="clearCache()" />
    <br />
    <label for="transport-select">Transport:</label>
    <select id="transport-select" onchange="switchTransport(this.value)">
        <option value="websocket">WebSocket (localhost:8080)</option>
        <option value="mqtt">MQTT (Mosquitto)</option>
    </select>
    <span id="connection-status" style="margin-left: 10px; font-weight: bold;">● Offline</span>
    <br />
    <div id="mqtt-config" style="display: none; margin-top: 10px; padding: 10px; background-color: #f0f0f0; border-radius: 4px;">
        <label for="mqtt-broker">MQTT Broker URL:</label>
        <input type="text" id="mqtt-broker" value="test.mosquitto.org" style="width: 250px;" />
        <label for="mqtt-port" style="margin-left: 20px;">Port:</label>
        <input type="number" id="mqtt-port" value="8081" style="width: 80px;" />
        <label for="mqtt-topic" style="margin-left: 20px;">Topic:</label>
        <input type="text" id="mqtt-topic" value="gc/data" style="width: 200px;" />
        <button onclick="applyMQTTConfig()" style="margin-left: 10px;">Apply & Reconnect</button>
    </div>
    <br />
    <hr />
    <gc-live-panel id="live"></gc-live-panel>
    <hr />
     
    <div class="w3-panel w3-light-grey">
        <p id="messages">Messages will appear here.</p>
    </div>
    <script>
        if ('serviceWorker' in navigator) {
            // navigator.serviceWorker.register('./sw.js', { scope: './' });            
        }
    </script>
    <script src="app.js"></script>
    <script>
        let mode = 'dark';
        const live = document.getElementById("live");
        w3.includeHTML();
        
        // Transport state
        let ws = null;
        let mqtt = null;
        let currentTransport = 'websocket';
        
        window.onload = function () {
            initWebSocket();
            applyColorMode(mode);
        };

        const key = 'vk_test_v1';
        function clearCache() {
            caches.delete(key);
            location.reload();
        }

        function toggleColorMode() {
            if(mode === 'dark') {
                mode = 'light';
            } else {
                mode = 'dark';
            }   
            applyColorMode(mode);
        }

        function applyColorMode(newMode) 
        {
            mode = newMode;
            document.body.style.backgroundColor = mode === 'dark' ? '#121212' : '#ffffff';
            document.body.style.color = mode === 'dark' ? '#e0e0e0' : '#000000';
            document.getElementById('live').setColorMode(mode);
        }    

        function showMessage(message) {
            const messages = document.getElementById('messages');
            if (!messages) return;
            messages.innerHTML = `${message}`;
        }

        function updateConnectionStatus(online, transport) {
            const status = document.getElementById('connection-status');
            if (!status) return;
            const color = online ? 'green' : 'red';
            const text = online ? '● Online' : '● Offline';
            status.style.color = color;
            status.textContent = `${text} (${transport})`;
        }

        function onMessage(msgData) {
            try {
                const msg = typeof msgData === 'string' ? JSON.parse(msgData) : msgData;
                if(msg.type && msg.type.startsWith("gc_")) {
                    live.update(msg);
                    showMessage(`Received: ${msg.type} - phase: ${msg.phase}, last: ${msg.last}, setning: ${msg.setning}`);
                }
            } catch (error) {
                showMessage(`Error parsing message: ${error.message}`);
            }
        }

        function initWebSocket() {
            if (ws) {
                showMessage('WebSocket is already initialized.');
                return;
            }
            ws = new WebSocket(`ws://localhost:8080`);
            ws.onerror = function () {
                showMessage('WebSocket error');
                updateConnectionStatus(false, 'WebSocket');
            };
            ws.onopen = function () {
                showMessage('WebSocket connection established');
                updateConnectionStatus(true, 'WebSocket');
            };
            ws.onclose = function () {
                showMessage('WebSocket connection closed');
                updateConnectionStatus(false, 'WebSocket');
                ws = null;
            };
            ws.onmessage = function (event) {
                onMessage(event.data);
            };
        }

        function initMQTT() {
            if (mqtt) {
                showMessage('MQTT is already initialized.');
                return;
            }

            const brokerUrl = document.getElementById('mqtt-broker').value || 'test.mosquitto.org';
            const brokerPort = parseInt(document.getElementById('mqtt-port').value) || 8081;
            const topic = document.getElementById('mqtt-topic').value || 'gc/data';
            const clientId = `gc_${Math.random().toString(16).substr(2, 9)}`;

            mqtt = new Paho.MQTT.Client(brokerUrl, brokerPort, clientId);
            mqtt.onConnectionLost = function (responseObject) {
                showMessage('MQTT connection lost');
                updateConnectionStatus(false, 'MQTT');
            };
            mqtt.onMessageArrived = function (message) {
                onMessage(message.payloadString);
            };

            mqtt.connect({
                onSuccess: function () {
                    showMessage('MQTT connection established');
                    updateConnectionStatus(true, 'MQTT');
                    mqtt.subscribe(topic);
                    showMessage(`Subscribed to topic: ${topic}`);
                },
                onFailure: function (error) {
                    showMessage(`MQTT connection failed: ${error.errorMessage}`);
                    updateConnectionStatus(false, 'MQTT');
                },
                useSSL: true,
                cleanSession: true
            });
        }

        function switchTransport(transport) {
            currentTransport = transport;

            if (transport === 'websocket') {
                // Close MQTT if active
                if (mqtt && mqtt.isConnected()) {
                    mqtt.disconnect();
                    mqtt = null;
                }
                // Init WebSocket if not already active
                if (!ws || ws.readyState !== WebSocket.OPEN) {
                    initWebSocket();
                }
                // Hide MQTT config
                document.getElementById('mqtt-config').style.display = 'none';
            } else if (transport === 'mqtt') {
                // Close WebSocket if active
                if (ws) {
                    ws.close();
                    ws = null;
                }
                // Show MQTT config
                document.getElementById('mqtt-config').style.display = 'block';
                // Init MQTT if not already active
                if (!mqtt || !mqtt.isConnected()) {
                    initMQTT();
                }
            }
        }

        function applyMQTTConfig() {
            // Reconnect MQTT with new config
            if (mqtt && mqtt.isConnected()) {
                mqtt.disconnect();
            }
            mqtt = null;
            if (currentTransport === 'mqtt') {
                initMQTT();
            }
        }

        function sendRequest(msg) {
            if (currentTransport === 'websocket' && ws && ws.readyState === WebSocket.OPEN) {
                ws.send(msg);
                setTimeout(function () {
                    showMessage("...");
                }, 2000);
            } else if (currentTransport === 'mqtt' && mqtt && mqtt.isConnected()) {
                const topic = 'gc/data';
                const message = new Paho.MQTT.Message(msg);
                message.destinationName = topic;
                mqtt.send(message);
                showMessage(`Published to ${topic}`);
            } else {
                showMessage(`Not connected via ${currentTransport}.`);
            }
        }

    </script>

</body>


</html>